<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>智能对话</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.1.0/github-markdown.min.css" rel="stylesheet">
    <style>
        .chat-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 15px;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 15px;
            clear: both;
        }
        .user-message {
            float: right;
            background-color: #dcf8c6;
            border-radius: 15px 0 15px 15px;
            padding: 10px;
            max-width: 80%;
        }
        .ai-message {
            float: left;
            background-color: #f1f0f0;
            border-radius: 0 15px 15px 15px;
            padding: 10px;
            max-width: 80%;
        }
        .message-content {
            white-space: pre-wrap;
        }
        .typing-indicator {
            display: none;
            margin-bottom: 15px;
            float: left;
        }
        .typing-indicator span {
            height: 10px;
            width: 10px;
            background-color: #6c757d;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">智能对话</h2>
        
        <div class="chat-container" id="chatContainer">
            <div class="message">
                <div class="ai-message">
                    <div class="message-content">您好！我是您的AI助手，有什么问题可以问我。</div>
                </div>
                <div style="clear:both"></div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <form id="chatForm" class="row g-3">
            <div class="col-md-9">
                <input type="text" class="form-control" id="promptInput" placeholder="请输入您的问题..." required>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">发送</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const chatContainer = document.getElementById('chatContainer');
        const chatForm = document.getElementById('chatForm');
        const promptInput = document.getElementById('promptInput');
        const typingIndicator = document.getElementById('typingIndicator');
        
        // 生成唯一会话ID
        const sessionId = Date.now().toString();
        let currentEventSource = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;
        
        // 添加用户消息到聊天窗口
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="user-message">
                    <div class="message-content">${text}</div>
                </div>
                <div style="clear:both"></div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // 添加AI回复到聊天窗口
        function addAiMessage(text, isMarkdown = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const content = isMarkdown ? marked.parse(text) : text;
            
            messageDiv.innerHTML = `
                <div class="ai-message">
                    <div class="message-content">${content}</div>
                </div>
                <div style="clear:both"></div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // 添加系统消息
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div style="text-align: center; color: #6c757d; margin: 10px 0;">
                    ${text}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // 显示正在输入指示器
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            scrollToBottom();
        }
        
        // 隐藏正在输入指示器
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }
        
        // 滚动到聊天窗口底部
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // 发送消息并处理流式响应
        function sendMessage(prompt) {
            addUserMessage(prompt);
            showTypingIndicator();
            reconnectAttempts = 0;
            
            // 关闭之前的事件源（如果有）
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            
            connectEventSource(prompt);
        }
        
        // 创建并连接EventSource
        function connectEventSource(prompt) {
            // 创建新的事件源
            const url = `/nexis-ai/chat?id=${sessionId}&prompt=${encodeURIComponent(prompt)}`;
            currentEventSource = new EventSource(url);
            
            let aiResponse = '';
            let aiMessageElement = null;
            let connectionEstablished = false;
            
            // 连接建立事件
            currentEventSource.addEventListener('connect', function(event) {
                connectionEstablished = true;
                console.log('SSE连接已建立');
            });
            
            // 消息事件
            currentEventSource.onmessage = function(event) {
                // 连接确认已建立
                connectionEstablished = true;
                
                // 首次收到消息时
                if (!aiMessageElement) {
                    hideTypingIndicator();
                    
                    // 创建新的AI消息元素
                    aiMessageElement = document.createElement('div');
                    aiMessageElement.className = 'message';
                    aiMessageElement.innerHTML = `
                        <div class="ai-message">
                            <div class="message-content"></div>
                        </div>
                        <div style="clear:both"></div>
                    `;
                    chatContainer.appendChild(aiMessageElement);
                }
                
                // 增量更新消息内容
                aiResponse += event.data;
                
                // 实时更新显示
                const contentElement = aiMessageElement.querySelector('.message-content');
                contentElement.innerHTML = marked.parse(aiResponse);
                
                scrollToBottom();
            };
            
            // 完成事件
            currentEventSource.addEventListener('complete', function(event) {
                console.log('对话完成');
                currentEventSource.close();
                currentEventSource = null;
                hideTypingIndicator();
            });
            
            // 错误事件
            currentEventSource.addEventListener('error', function(event) {
                console.log('收到错误事件', event.data);
                if (aiMessageElement) {
                    const contentElement = aiMessageElement.querySelector('.message-content');
                    contentElement.innerHTML += `<div class="text-danger">⚠️ ${event.data || '对话处理出错'}</div>`;
                }
                currentEventSource.close();
                currentEventSource = null;
                hideTypingIndicator();
            });
            
            // 连接错误处理
            currentEventSource.onerror = function(error) {
                console.error('EventSource错误:', error);
                
                // 如果连接尚未建立，尝试重连
                if (!connectionEstablished && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    console.log(`尝试重新连接 (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                    
                    // 关闭当前连接
                    currentEventSource.close();
                    currentEventSource = null;
                    
                    // 延迟重连
                    setTimeout(() => {
                        addSystemMessage(`连接中断，正在重试 (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                        connectEventSource(prompt);
                    }, 1000 * reconnectAttempts); // 递增延迟
                    
                    return;
                }
                
                // 超过重试次数或连接已建立但出错
                currentEventSource.close();
                currentEventSource = null;
                hideTypingIndicator();
                
                // 如果尚未创建AI消息元素，则创建一个错误消息
                if (!aiMessageElement) {
                    addAiMessage('⚠️ 对话链接异常，请重试。', false);
                } else if (connectionEstablished) {
                    // 连接已建立但中途断开
                    const contentElement = aiMessageElement.querySelector('.message-content');
                    contentElement.innerHTML += '<div class="text-danger">⚠️ 连接中断，但已收到部分回复。</div>';
                }
            };
        }
        
        // 提交表单时发送消息
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const prompt = promptInput.value.trim();
            if (prompt) {
                sendMessage(prompt);
                promptInput.value = '';
            }
        });
        
        // 配置 marked 选项
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            smartLists: true
        });
    </script>
</body>
</html> 